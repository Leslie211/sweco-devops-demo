deploy:
  needs: build-and-push
  runs-on: ubuntu-latest
  env:
    GITHUB_SHA: ${{ github.sha }}
    IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy to k3s VM
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -euo pipefail

          TAG="$IMAGE_TAG"
          IMAGE="${{ env.IMAGE_NAME }}:${TAG}"

          echo "Deploying image: ${IMAGE}"
          echo "Run number (tag): ${TAG}"
          echo "Commit: $GITHUB_SHA"

          if [ ! -d ~/sweco-devops-demo ]; then
            git clone https://github.com/${{ github.repository_owner }}/sweco-devops-demo.git ~/sweco-devops-demo
          else
            cd ~/sweco-devops-demo && git fetch --all && git reset --hard origin/main || true
          fi
          cd ~/sweco-devops-demo

          # first-time create or update
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml || true

          # update image to build-number tag
          kubectl -n default set image deployment/sweco-demo sweco-demo=$IMAGE

          # annotate deployment
          kubectl -n default patch deployment sweco-demo -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"deployed-build\":\"${TAG}\",\"deployed-git-sha\":\"${GITHUB_SHA}\"}}}}}"

          kubectl -n default rollout status deployment/sweco-demo --timeout=120s

          kubectl -n default get deployment sweco-demo -o jsonpath='{.spec.template.spec.containers[0].image}'; echo
          kubectl -n default get pods -o wide

